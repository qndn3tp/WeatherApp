name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  lint:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'
          
      - name: Install dependencies
        run: |
          if [ -f "Podfile" ]; then
            sudo gem install cocoapods
            pod install --repo-update
          fi

      - name: Create SwiftLint config
        run: |
          cat > .swiftlint.yml << EOF
          identifier_name:
            min_length: 1
            max_length: 40
            excluded: 
              - i
              - j
              - x
              - y
          line_length: 120
          EOF
          
      - name: Lint code for consistent style
        run: |
          if ! command -v swiftlint &> /dev/null; then
            brew install swiftlint
          fi
          swiftlint lint Weather

  test:
    runs-on: macos-14
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'
          
      - name: Install dependencies
        run: |
          if [ -f "Podfile" ]; then
            sudo gem install cocoapods
            pod install --repo-update
          fi
          
      - name: Run tests
        run: |
          if [ -f "Weather.xcworkspace" ]; then
            PROJECT_FILE="Weather.xcworkspace"
            BUILD_FLAG="-workspace"
          else
            PROJECT_FILE="Weather.xcodeproj"
            BUILD_FLAG="-project"
          fi
          
          xcodebuild clean test \
            $BUILD_FLAG "$PROJECT_FILE" \
            -scheme Weather \
            -destination "platform=iOS Simulator,name=iPhone 16,OS=18.1" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
